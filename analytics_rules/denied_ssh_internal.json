{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/<GUID>')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/<GUID>')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2023-12-01-preview",
            "properties": {
                "displayName": "Denied SSH Internal",
                "description": "Denied SSH connection to/from Internal IPs",
                "severity": "Informational",
                "enabled": true,
                "query": "let excludedSRCIPs = dynamic([\n    \"<PRIVATE_IP>\", \"<PRIVATE_IP>\", \"<PRIVATE_IP>\", \n    \"<PRIVATE_IP>\", \"<PRIVATE_IP>\", \"<PRIVATE_IP>\", \"<PRIVATE_IP>\", \n    \"<PRIVATE_IP>\", \"<PRIVATE_IP>\", \"<PRIVATE_IP>\", \n    \"<PRIVATE_IP>\", \"<PRIVATE_IP>\", \"<PRIVATE_IP>\", \n    \"<PRIVATE_IP>\", \"<PRIVATE_IP>\", \"<PRIVATE_IP>\", \"<PRIVATE_IP>\",\n    \"<PRIVATE_IP>\", \"<PRIVATE_IP>\", \"<PRIVATE_IP>\", \"<PRIVATE_IP>\", \n    \"<PRIVATE_IP>\", \"<PRIVATE_IP>\", \"<PRIVATE_IP>\", \"<PRIVATE_IP>\", \n    \"<PRIVATE_IP>\", \"<PRIVATE_IP>\", \"<PRIVATE_IP>\", \"<PRIVATE_IP>\", \n    \"<PRIVATE_IP>\", \"<PRIVATE_IP>\", \"<PRIVATE_IP>\", \"<PRIVATE_IP>\", \n    \"<PRIVATE_IP>\", \"<PRIVATE_IP>\", \"<PRIVATE_IP>\", \"<PRIVATE_IP>\",\n    \"<PRIVATE_IP>\", \"<PRIVATE_IP>\", \"<PRIVATE_IP>\"\n]);\nSyslog\n| where SyslogMessage contains \"DenySSH:\"\n| where SyslogMessage !contains \"IN=lo\" and SyslogMessage !contains \"puppet-agent\"\n| extend SRC_IP = extract(\"SRC=([\\\\d.]+)\", 1, SyslogMessage)\n| extend DST_IP = extract(\"DST=([\\\\d.]+)\", 1, SyslogMessage)\n| where not (SRC_IP in (excludedSRCIPs))\n| where not (\n    (SRC_IP == \"<PRIVATE_IP>\" and Computer startswith \"kellercpdev\") or\n    (SRC_IP == \"<PRIVATE_IP>\" and Computer startswith \"kellercpdev\") or\n    (SRC_IP startswith \"192.168.203\" and Computer startswith \"kellerny\") or\n    (SRC_IP startswith \"10.201.44\" and Computer startswith \"wsfnyopsprod\") or\n    (SRC_IP == \"<PRIVATE_IP>\" and Computer startswith \"unisphere\") or\n    (SRC_IP == \"<PRIVATE_IP>\" and Computer startswith \"asfnysalta\") or\n    (SRC_IP == \"<PRIVATE_IP>\" and Computer startswith \"kellerny\") or\n    (SRC_IP startswith \"192.168.9\" and Computer startswith \"kellerny\") or\n    (SRC_IP startswith \"192.168.9\" and Computer startswith \"dbblk\") or\n    (SRC_IP == \"<PRIVATE_IP>\" and Computer startswith \"kellerny\") or\n    (SRC_IP == \"<PRIVATE_IP>\" and Computer startswith \"jcpnydev\") or\n    (SRC_IP == \"<PRIVATE_IP>\" and Computer startswith \"dbblkabva\") or\n    (SRC_IP == \"<PRIVATE_IP>\" and Computer == \"dbvcsfnyprod01\") or\n    (SRC_IP == \"<PRIVATE_IP>\" and Computer == \"jsfnyprod21\") or\n    (SRC_IP == \"<PRIVATE_IP>\" and Computer == \"dbbocoprod17\") or\n    (SRC_IP == \"<PRIVATE_IP>\" and Computer startswith \"yanagvaprod\") or\n    (SRC_IP == \"<PRIVATE_IP>\" and Computer startswith \"wsfnystg\") or\n    (SRC_IP == \"<PRIVATE_IP>\" and Computer == \"irbocoprod01\") or\n    (SRC_IP == \"<PRIVATE_IP>\" and Computer == \"dbmonitor\") or\n    (SRC_IP == \"<PRIVATE_IP>\" and Computer startswith \"solrsfny\") or\n    (SRC_IP == \"<PRIVATE_IP>\" and Computer startswith \"dbsfnyprod\") or\n    (SRC_IP == \"<PRIVATE_IP>\" and Computer startswith \"kmbocoprod\") or\n    (SRC_IP == \"<PRIVATE_IP>\" and Computer startswith \"dbbocostg\") or\n    (SRC_IP == \"<PRIVATE_IP>\" and Computer startswith \"jsfnyqa0\")\n)\n| summarize Count=count(), DST_Values=make_set(HostIP) by Source=SRC_IP\n| project Source, Count, DST_Values\n| where Count > 5\n",
                "queryFrequency": "PT30M",
                "queryPeriod": "PT30M",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT5H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": [
                    "InitialAccess"
                ],
                "techniques": [],
                "subTechniques": [],
                "alertRuleTemplateName": null,
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": true,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "P1D",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": [],
                        "groupByCustomDetails": []
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": {
                    "alertDynamicProperties": []
                },
                "customDetails": {},
                "entityMappings": [
                    {
                        "entityType": "IP",
                        "fieldMappings": [
                            {
                                "identifier": "Address",
                                "columnName": "Source"
                            }
                        ]
                    },
                    {
                        "entityType": "IP",
                        "fieldMappings": [
                            {
                                "identifier": "Address",
                                "columnName": "DST_Values"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": null
            }
        }
    ]
}