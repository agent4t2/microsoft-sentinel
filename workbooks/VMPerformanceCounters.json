{
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "VM Performance Counters",
      "metadata": {
        "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
      }
    },
    "workbookType": {
      "type": "string",
      "defaultValue": "sentinel",
      "metadata": {
        "description": "The gallery that the workbook will been shown under. Supported values include workbook, tsg, etc. Usually, this is 'workbook'"
      }
    },
    "workbookSourceId": {
      "type": "string",
      "defaultValue": "/subscriptions/<SUBSCRIPTION-ID>/resourcegroups/<RESOURCE-GROUP>/providers/microsoft.operationalinsights/workspaces/<WORKSPACE-NAME>",
      "metadata": {
        "description": "The id of resource instance to which the workbook will be associated"
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "<WORKBOOK-GUID>",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    }
  },
  "resources": [
    {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2022-04-01",
      "dependsOn": [],
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"839c02d2-965c-42dd-8579-a5586a428178\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Tab\",\"type\":11,\"typeSettings\":{\"additionalResourceOptions\":[],\"showDefault\":false},\"jsonData\":\"[\\\"Overview\\\", \\\"Server Detail\\\", \\\"Host Group Detail\\\", \\\"Tab 04\\\"]\",\"timeContext\":{\"durationMs\":86400000},\"value\":\"Host Group Detail\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"Tab Selector\"}, ... FULL LIST OF ITEMS ..., {\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let GroupPatterns = datatable(Group:string, Regex:string)\\n[\\n    \\\"-Group- Group1\\\", @\\\"prod|prod0|p0\\\",\\n    \\\"-Group- Group2\\\", @\\\"dev|d0\\\",\\n    \\\"-Group- Group3\\\", @\\\"q0|qa\\\",\\n    \\\"-Group- Group4\\\", @\\\"db|ebs|ora\\\",\\n    \\\"-Group- Group5\\\", @\\\"atl|atlas\\\",\\n    \\\"-Group- Group6\\\", @\\\"sap\\\",\\n    \\\"-Group- Group7\\\", @\\\"collector\\\"\\n];\\nlet paramHosts = '{SelectedHosts}';\\nlet hosts = iif(isempty(paramHosts), dynamic([]), iif(paramHosts contains '\\\",\\\"', split(trim('\\\"', paramHosts), '\\\",\\\"'), parse_json(strcat('[\\\"', trim('\\\"', paramHosts), '\\\"]'))));\\nlet AllComputerList = Perf | summarize by Computer=tostring(Computer);\\nlet SelectedGroups = range i from 0 to array_length(hosts)-1 step 1 | extend Group = tostring(hosts[i]) | where Group in (GroupPatterns | project Group);\\nlet SelectedHostnames = range i from 0 to array_length(hosts)-1 step 1 | extend Computer = tostring(hosts[i]) | where Computer !in (GroupPatterns | project Group);\\nlet HostsFromGroups = union (SelectedGroups | extend pat = Regex, key=1 | join kind=inner (AllComputerList | extend key=1) on key | where tostring(Computer) matches regex pat | project Computer);\\nlet FilteredHosts = ((HostsFromGroups) | union (SelectedHostnames | project Computer) | union (datatable(Computer:string) []) | summarize by Computer);\\nPerf | join kind=inner (FilteredHosts) on Computer | where CounterName == \\\"% Processor Time\\\" | summarize AvgCPU = avg(CounterValue) by bin(TimeGenerated, 15m), Computer | order by TimeGenerated asc | render timechart\",\"size\":1,\"aggregation\":3,\"title\":\"CPU Performance (% Processor Time)\",\"timeContextFromParameter\":\"_TimeRange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"chartSettings\":{\"showLegend\":true}}}]},\"isLocked\":false,\"fallbackResourceIds\":[\"/subscriptions/<SUBSCRIPTION-ID>/resourcegroups/<RESOURCE-GROUP>/providers/microsoft.operationalinsights/workspaces/<WORKSPACE-NAME>\"],\"fromTemplateId\":\"sentinel-UserWorkbook\"}",
        "version": "1.0",
        "sourceId": "[parameters('workbookSourceId')]",
        "category": "[parameters('workbookType')]"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
    }
  },
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#"
}
