// Get daily totals
let DailyData =
    Usage
    | where TimeGenerated between (startofday(ago(90d)) .. endofday(ago(1d)))
    | where IsBillable == true
    | summarize DailyGB = sum(Quantity) / 1024 by bin(TimeGenerated, 1d);
// Flat 60-day average as a scalar
let FlatAvg = toscalar(DailyData | summarize avg(DailyGB));
// Build time series with rolling avg
let SeriesData =
    DailyData
    | make-series DailyGB = avg(DailyGB) on TimeGenerated 
        from startofday(ago(90d)) to endofday(ago(1d)) step 1d
    | extend RollingAvg = series_fir(DailyGB, repeat(1.0/7, 7))
    | mv-expand TimeGenerated to typeof(datetime), 
                DailyGB to typeof(real), 
                RollingAvg to typeof(real)
    | serialize
    | extend RowNumber = row_number()
    | where RowNumber > 6   // drop first 6 rows (partial averages)
    | extend FlatAvg = FlatAvg;
// Anomalies: Â±20% from rolling average
let Anomalies =
    SeriesData
    | where DailyGB > RollingAvg * 1.2 or DailyGB < RollingAvg * 0.8
    | project TimeGenerated, AnomalyValue = DailyGB;
// Combine for visualization
SeriesData
| project TimeGenerated, DailyGB, RollingAvg, FlatAvg
| join kind=leftouter (Anomalies) on TimeGenerated
| render timechart
